<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/rekognition/rekognition.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/rekognition/rekognition.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';



const upload = require('./upload');
const {exec} = require('child_process');

//Global Variables
//improve variable name
let frameCount = 0;
let run = true;
let sessionData = [];
let engagementThreshold = 20;
const emotionThreshold = 50;
const S3imageDelay = 3;
const rekognitionDelay = 4;

/**
 * Taking picture through fswebcam command
 * @param frameCount
 */
function takePicture(frameCount) {

  exec(`fswebcam -r 1280x960 images/image${frameCount}.jpg`, (error, stdout, stderr) => {
    if (error) {
      errorHandler(error);
      return;
    }
    // console.log(`stdout: ${stdout}`);
    errorHandler(stderr);
  });
}

/**
 * function sends photo from S3 to rekognition
 * @param frameCount
 */
function facialRecognition (frameCount) {
  let awsTerminalCommand = `aws rekognition detect-faces --image '{"S3Object":{"Bucket":"spike-test2","Name":"image${frameCount}.jpg"}}' --attributes "ALL"`;
  exec(awsTerminalCommand, (error, stdout, stderr) => {
    if (error) {
      errorHandler(error);
      return;
    }
    let parsed = JSON.parse(stdout);
    if(parsed.FaceDetails) {
      let output = parsed.FaceDetails;
      let frameData = output.reduce( ( dataCount, person ) => {
        if (Math.abs(person.Pose.Yaw) &lt; engagementThreshold &amp;&amp; Math.abs(person.Pose.Pitch) &lt; engagementThreshold ) {
          dataCount.Engaged++;
        } else {
          dataCount.Unengaged++;
        }
        dataCount.Average = dataCount.Engaged / ( dataCount.Engaged + dataCount.Unengaged );
        // let emotionArray = output.Emotions;
        // for( let i = 0; i &lt; emotionArray.length; i++ ){
        //   if( emotionArray[i].Confidence > emotionThreshold ){
        //     dataCount.Emotion.push(emotionArray[i].Type);
        //   }
        // }
        return dataCount;
      }, { Engaged: 0, Unengaged: 0, Average: 0 }).Average;
      // console.log(`Engaged: ${frameData.Engaged}, Unengaged: ${frameData.Unengaged}`);
      console.log(`Average: ${frameData}`);
      sessionData.push(frameData);
    }
    errorHandler(stderr);

  });
}

// function sessionAnalysis ( sessionDataArray ){
//
//   let data = sessionDataArray.reduce( (accumulator, frame) => {
//     accumulator.Engaged += frame.Engaged;
//     accumulator.Unengaged += frame.Unengaged;
//     return accumulator;
//   }, { Engaged:0, Unengaged:0 });
//   console.log( data );
//   return data;
// }

/**
 * Starts rekognition loop
 * @type {Function}
 */
const startRekognition = ( () => {
  const looper = setInterval(function () {
    let picCount = 0;
    if (picCount > 15) {
      console.log('--------stopping---------');
      // sessionAnalysis(sessionData);
      return sessionData;
      clearInterval(looper);
    }
      frameCount++;

      //Take a picture
      takePicture(frameCount);

      //uploads image to S3
      if (frameCount > S3imageDelay) {
        upload(`./images/image${frameCount - 1}.jpg`);
      }
      //Send images to rekognition
      if (frameCount > rekognitionDelay) {
        facialRecognition(frameCount - 2);
      }
  }, 3000);

});


function recognitionHandler(req, res) {
  // anything from the client => req
  // anything you want to return => res
}

/**
 * Error handler
 * @param err
 */
function errorHandler(err){
  console.log(err);
}

module.exports =  startRekognition;

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-src_auth_user-model.html">src/auth/user-model</a></li><li><a href="src_middleware_404.html#.module:js">js</a></li><li><a href="src_middleware_error.html#.module:js">js</a></li><li><a href="src_rekognition_upload.module_js.html">js</a></li></ul><h3>Global</h3><ul><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#facialRecognition">facialRecognition</a></li><li><a href="global.html#mongoose">mongoose</a></li><li><a href="global.html#startRekognition">startRekognition</a></li><li><a href="global.html#takePicture">takePicture</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Sep 12 2019 14:17:20 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
